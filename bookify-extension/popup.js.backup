// --- CONFIGURATION ---
const firebaseConfig = {
    apiKey: "AIzaSyBBMGdORhteEe1QtQqBQIaiOq6NWe5eJfE",
    authDomain: "bookify-extension.firebaseapp.com",
    projectId: "bookify-extension",
    storageBucket: "bookify-extension.firebasestorage.app",
    messagingSenderId: "882791110164",
    appId: "1:882791110164:web:ee21a39f638bb7ff247901"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- STATE MANAGEMENT ---
let currentUser = null;
let bookmarks = [];
let privateBookmarks = [];
let aiMetadata = {}; // { url: { category: '...', tags: [...] } }
let apiKey = '';
let tagsMap = {};
let isVaultUnlocked = false;

const screens = {
    auth: document.getElementById('auth-screen'),
    dashboard: document.getElementById('dashboard-screen')
};
const views = {
    categories: document.getElementById('categories-view'),
    all: document.getElementById('all-bookmarks-view'),
    privateLocked: document.getElementById('private-locked-view'),
    privateUnlocked: document.getElementById('private-unlocked-view')
};

// --- AUTHENTICATION ---
document.getElementById('google-login-btn').addEventListener('click', () => {
    chrome.identity.getAuthToken({ interactive: true }, function (token) {
        if (chrome.runtime.lastError) {
            console.error(chrome.runtime.lastError);
            alert("Login failed: " + chrome.runtime.lastError.message);
            return;
        }
        const credential = firebase.auth.GoogleAuthProvider.credential(null, token);
        auth.signInWithCredential(credential).catch((error) => {
            alert("Firebase Login Error: " + error.message);
        });
    });
});

document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        document.getElementById('user-email').innerText = user.email;
        screens.auth.classList.add('hidden');
        screens.dashboard.classList.remove('hidden');
        await loadUserData();
        loadChromeBookmarks();
    } else {
        currentUser = null;
        screens.auth.classList.remove('hidden');
        screens.dashboard.classList.add('hidden');
    }
});

// --- SEARCH LOGIC ---
document.getElementById('search-input').addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();

    if (query.length > 0) {
        // Filter Logic
        const filtered = bookmarks.filter(bm => {
            const inTitle = bm.title.toLowerCase().includes(query);
            const inUrl = bm.url.toLowerCase().includes(query);
            const tags = tagsMap[bm.url] || [];
            const inTags = tags.some(t => t.toLowerCase().includes(query));
            return inTitle || inUrl || inTags;
        });

        // Force switch to 'All' view to show results
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[data-tab="all-bookmarks"]`).classList.add('active');

        views.categories.classList.add('hidden');
        views.privateLocked.classList.add('hidden');
        views.privateUnlocked.classList.add('hidden');
        views.all.classList.remove('hidden');

        renderAllBookmarks(filtered);
    } else {
        // If query cleared, reload all
        renderAllBookmarks();
    }
});

// --- DATA HANDLING ---
async function loadUserData() {
    if (!currentUser) return;
    const userRef = db.collection("users").doc(currentUser.uid);
    const docSnap = await userRef.get();

    if (docSnap.exists) {
        const data = docSnap.data();
        tagsMap = data.tags || {};
        privateBookmarks = data.privateBookmarks || [];
        aiMetadata = data.aiMetadata || {};
    } else {
        await userRef.set({ tags: {}, privateBookmarks: [], aiMetadata: {} });
    }

    // Load API Key
    chrome.storage.local.get(['gemini_api_key'], (result) => {
        if (result.gemini_api_key) {
            apiKey = result.gemini_api_key;
            document.getElementById('gemini-api-key').value = apiKey;
            document.getElementById('analyze-btn').disabled = false;
        }
    });
}

function loadChromeBookmarks() {
    chrome.bookmarks.getTree((bookmarkTreeNodes) => {
        bookmarks = [];
        processBookmarkTree(bookmarkTreeNodes);
        renderCategories();
        renderAllBookmarks();
    });
}

function processBookmarkTree(nodes) {
    nodes.forEach(node => {
        if (node.url) {
            bookmarks.push({
                id: node.id,
                title: node.title,
                url: node.url,
                dateAdded: node.dateAdded
            });
        }
        if (node.children) {
            processBookmarkTree(node.children);
        }
    });
}

function getBookmarksByCategory(categoryName) {
    if (categoryName === 'Unsorted') {
        return bookmarks.filter(bm => {
            const meta = aiMetadata[bm.url];
            return !meta || !meta.category;
        });
    }
    return bookmarks.filter(bm => {
        const meta = aiMetadata[bm.url];
        return meta && meta.category === categoryName;
    });
}

// --- RENDERING ---
function renderCategories() {
    const grid = document.getElementById('category-grid');
    grid.innerHTML = '';

    // Group bookmarks by AI category
    const groups = {};
    bookmarks.forEach(bm => {
        const meta = aiMetadata[bm.url];
        const cat = (meta && meta.category) ? meta.category : 'Unsorted';
        if (!groups[cat]) groups[cat] = [];
        groups[cat].push(bm);
    });

    Object.keys(groups).sort().forEach(cat => {
        const items = groups[cat];
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `
            <span class="cat-name">${cat}</span>
            <span class="cat-count">${items.length} items</span>
        `;
        card.onclick = () => {
            showCategoryDetail(cat, items);
        };
        grid.appendChild(card);
    });
}

function showCategoryDetail(categoryName, items) {
    document.getElementById('category-grid').classList.add('hidden');
    document.getElementById('category-detail-view').classList.remove('hidden');
    document.getElementById('category-title').innerText = categoryName;

    renderBookmarkList(items, 'category-list');
}

document.getElementById('back-to-categories').addEventListener('click', () => {
    document.getElementById('category-detail-view').classList.add('hidden');
    document.getElementById('category-grid').classList.remove('hidden');
});

function renderAllBookmarks(subset = null) {
    const data = subset || bookmarks;
    renderBookmarkList(data, 'bookmarks-list');
}

function renderBookmarkList(data, listId) {
    const list = document.getElementById(listId);
    list.innerHTML = '';

    if (data.length === 0) {
        list.innerHTML = '<li class="empty-list-msg">No bookmarks found</li>';
        return;
    }

    data.forEach(bm => {
        const li = document.createElement('li');
        li.className = 'bookmark-item';

        const manualTags = tagsMap[bm.url] || [];
        const aiTags = (aiMetadata[bm.url] && aiMetadata[bm.url].tags) ? aiMetadata[bm.url].tags : [];

        // Filter out duplicates
        const uniqueAiTags = aiTags.filter(t => !manualTags.includes(t));

        li.innerHTML = `
            <div class="bm-header">
                <a href="${bm.url}" target="_blank" class="bm-link" title="${bm.title}">
                    <img src="https://www.google.com/s2/favicons?domain=${bm.url}" class="favicon-img">
                    ${bm.title}
                </a>
                <div class="bm-actions">
                    <i class="fas fa-lock lock-btn move-to-vault" data-id="${bm.id}" title="Move to Vault"></i>
                    <i class="fas fa-trash delete-btn public-delete" data-id="${bm.id}"></i>
                </div>
            </div>
            <div class="tags-container" id="tags-${bm.id}">
                ${manualTags.map(t => `<span class="tag">${t} <i class="fas fa-times" data-remove-tag="${t}" data-url="${bm.url}"></i></span>`).join('')}
                ${uniqueAiTags.map(t => `<span class="tag ai-tag"><i class="fas fa-robot"></i> ${t}</span>`).join('')}
                <input type="text" class="tag-input" placeholder="+ Tag" data-url="${bm.url}">
            </div>
        `;
        list.appendChild(li);
    });
    attachItemListeners();
}

function attachItemListeners() {
    document.querySelectorAll('.tag-input').forEach(input => {
        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const tag = e.target.value.trim();
                const url = e.target.dataset.url;
                if (tag) {
                    if (!tagsMap[url]) tagsMap[url] = [];
                    if (!tagsMap[url].includes(tag)) {
                        tagsMap[url].push(tag);
                        await syncTags();
                        renderAllBookmarks();
                    }
                }
            }
        });
    });

    document.querySelectorAll('[data-remove-tag]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const tag = e.target.dataset.removeTag;
            const url = e.target.dataset.url;
            tagsMap[url] = tagsMap[url].filter(t => t !== tag);
            await syncTags();
            renderAllBookmarks();
        });
    });

    document.querySelectorAll('.public-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            if (confirm("Are you sure you want to delete this bookmark?")) {
                chrome.bookmarks.remove(id, () => {
                    loadChromeBookmarks();
                });
            }
        });
    });

    document.querySelectorAll('.move-to-vault').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const bookmark = bookmarks.find(b => b.id === id);

            if (!currentUser) {
                alert("Please login to use the Vault.");
                return;
            }

            if (confirm("Move to Vault? This will remove it from Chrome bookmarks.")) {
                const newBm = { url: bookmark.url, title: bookmark.title, createdAt: new Date().toISOString() };

                // Add to Firestore
                const userRef = db.collection("users").doc(currentUser.uid);
                await userRef.update({
                    privateBookmarks: firebase.firestore.FieldValue.arrayUnion(newBm)
                });

                // Remove from Chrome
                chrome.bookmarks.remove(id, () => {
                    // Update local state
                    privateBookmarks.push(newBm);
                    loadChromeBookmarks(); // Reloads public list
                    // Optional: Switch to vault view or just notify
                    // switchTab('private'); 
                });
            }
        });
    });
}

async function syncTags() {
    if (!currentUser) return;
    const userRef = db.collection("users").doc(currentUser.uid);
    await userRef.update({ tags: tagsMap });
}

// --- TABS & NAVIGATION ---
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const tab = e.target.closest('.tab-btn').dataset.tab;
        switchTab(tab);
    });
});

function switchTab(tabName, refresh = true) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));

    const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (activeBtn) activeBtn.classList.add('active');

    const searchContainer = document.getElementById('search-container');

    if (tabName === 'private') {
        checkVaultLock();
    } else {
        if (searchContainer) searchContainer.classList.remove('hidden');

        if (tabName === 'categories') {
            renderCategories();
            document.getElementById('category-grid').classList.remove('hidden');
            document.getElementById('category-detail-view').classList.add('hidden');
            views.categories.classList.remove('hidden');
        } else if (tabName === 'all-bookmarks') {
            document.getElementById('search-input').value = '';
            if (refresh) renderAllBookmarks();
            views.all.classList.remove('hidden');
        }
    }
}

// --- PRIVATE VAULT LOGIC ---

function checkVaultLock() {
    const searchContainer = document.getElementById('search-container');

    if (isVaultUnlocked) {
        // Unlock View
        renderPrivateBookmarks();
        views.privateUnlocked.classList.remove('hidden');
        if (searchContainer) searchContainer.classList.remove('hidden');
    } else {
        // Locked View
        views.privateLocked.classList.remove('hidden');
        if (searchContainer) searchContainer.classList.add('hidden');

        chrome.storage.local.get(['bookify_pin'], (result) => {
            const savedPin = result.bookify_pin;
            if (!savedPin) {
                document.getElementById('setup-pin-section').classList.remove('hidden');
            } else {
                document.getElementById('setup-pin-section').classList.add('hidden');
            }
        });
    }
}

// Setup New PIN
const setPinBtn = document.getElementById('set-pin-btn');
if (setPinBtn) {
    setPinBtn.addEventListener('click', () => {
        const pin = document.getElementById('new-pin').value;
        if (pin.length === 4) {
            chrome.storage.local.set({ bookify_pin: pin }, () => {
                alert("PIN set successfully!");
                document.getElementById('setup-pin-section').classList.add('hidden');
            });
        }
    });
}

// Unlock Vault
const unlockBtn = document.getElementById('unlock-vault-btn');
if (unlockBtn) {
    unlockBtn.addEventListener('click', () => {
        const inputPin = document.getElementById('vault-pin').value;

        chrome.storage.local.get(['bookify_pin'], (result) => {
            const savedPin = result.bookify_pin;

            if (inputPin === savedPin) {
                isVaultUnlocked = true;
                document.getElementById('vault-error').classList.add('hidden');
                views.privateLocked.classList.add('hidden');
                checkVaultLock();
            } else {
                document.getElementById('vault-error').classList.remove('hidden');
            }
        });
    });
}

// Lock Button Logic
const lockBtn = document.getElementById('lock-vault-btn');
if (lockBtn) {
    lockBtn.addEventListener('click', () => {
        isVaultUnlocked = false;
        document.getElementById('vault-pin').value = '';
        switchTab('private');
    });
}

// Add Private Bookmark
const addPrivateBtn = document.getElementById('add-private-btn');
if (addPrivateBtn) {
    addPrivateBtn.addEventListener('click', async () => {
        const url = document.getElementById('private-url').value;
        const title = document.getElementById('private-title').value;
        if (url && title) {
            const newBm = { url, title, createdAt: new Date().toISOString() };
            privateBookmarks.push(newBm);

            const userRef = db.collection("users").doc(currentUser.uid);
            await userRef.update({
                privateBookmarks: firebase.firestore.FieldValue.arrayUnion(newBm)
            });

            renderPrivateBookmarks();
            document.getElementById('private-url').value = '';
            document.getElementById('private-title').value = '';
        }
    });
}

function renderPrivateBookmarks() {
    const list = document.getElementById('private-list');
    list.innerHTML = '';
    privateBookmarks.forEach((bm, index) => {
        const li = document.createElement('li');
        li.className = 'bookmark-item private-bookmark-item';
        li.innerHTML = `
            <div class="bm-header">
                <a href="${bm.url}" target="_blank" class="bm-link">${bm.title}</a>
                <div class="bm-actions">
                    <i class="fas fa-unlock lock-btn move-to-public" data-index="${index}" title="Move to Public"></i>
                    <i class="fas fa-trash delete-btn private-delete" data-index="${index}"></i>
                </div>
            </div>
        `;
        list.appendChild(li);
    });

    document.querySelectorAll('.private-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const index = e.target.dataset.index;
            if (confirm("Delete from Vault?")) {
                const itemToDelete = privateBookmarks[index];
                privateBookmarks.splice(index, 1);

                const userRef = db.collection("users").doc(currentUser.uid);
                await userRef.update({
                    privateBookmarks: firebase.firestore.FieldValue.arrayRemove(itemToDelete)
                });

                renderPrivateBookmarks();
            }
        });
    });

    document.querySelectorAll('.move-to-public').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const index = e.target.dataset.index;
            const itemToMove = privateBookmarks[index];

            if (confirm("Move to Public? This will make it visible in Chrome bookmarks.")) {
                // Create in Chrome
                chrome.bookmarks.create({
                    title: itemToMove.title,
                    url: itemToMove.url
                }, async () => {
                    // Remove from Firestore
                    privateBookmarks.splice(index, 1);
                    const userRef = db.collection("users").doc(currentUser.uid);
                    await userRef.update({
                        privateBookmarks: firebase.firestore.FieldValue.arrayRemove(itemToMove)
                    });

                    renderPrivateBookmarks();
                    loadChromeBookmarks(); // Refresh public list
                    // Optional: Notify user
                    // alert("Moved to Public Bookmarks");
                });
            }
        });
    });
}

// FEATURE: Change PIN Logic
const updatePinBtn = document.getElementById('update-pin-btn');
if (updatePinBtn) {
    updatePinBtn.addEventListener('click', () => {
        const oldPinInput = document.getElementById('old-pin-input').value;
        const newPinInput = document.getElementById('new-pin-input').value;
        const msg = document.getElementById('pin-msg');

        chrome.storage.local.get(['bookify_pin'], (result) => {
            const savedPin = result.bookify_pin;

            if (oldPinInput !== savedPin) {
                msg.style.color = 'red';
                msg.innerText = "Old PIN is incorrect.";
                return;
            }

            if (newPinInput.length !== 4) {
                msg.style.color = 'red';
                msg.innerText = "New PIN must be 4 digits.";
                return;
            }

            chrome.storage.local.set({ bookify_pin: newPinInput }, () => {
                msg.style.color = 'green';
                msg.innerText = "PIN updated successfully!";

                document.getElementById('old-pin-input').value = '';
                document.getElementById('new-pin-input').value = '';
            });
        });
    });
}

// --- SETTINGS LOGIC ---
document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-view').classList.remove('hidden');
    views.categories.classList.add('hidden');
    views.all.classList.add('hidden');
    views.privateLocked.classList.add('hidden');
    views.privateUnlocked.classList.add('hidden');

    // Reset tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
});

document.getElementById('save-api-key-btn').addEventListener('click', () => {
    const key = document.getElementById('gemini-api-key').value.trim();
    if (key) {
        chrome.storage.local.set({ gemini_api_key: key }, () => {
            apiKey = key;
            document.getElementById('api-key-status').innerText = "API Key Saved!";
            document.getElementById('api-key-status').style.color = "green";
            document.getElementById('analyze-btn').disabled = false;
            setTimeout(() => { document.getElementById('api-key-status').innerText = ""; }, 3000);
        });
    }
});

document.getElementById('analyze-btn').addEventListener('click', async () => {
    if (!apiKey) return;

    const btn = document.getElementById('analyze-btn');
    const progress = document.getElementById('analysis-progress');
    const status = document.getElementById('analysis-status');

    btn.disabled = true;
    progress.classList.remove('hidden');
    status.innerText = "Analyzing bookmarks...";

    try {
        await analyzeBookmarksWithGemini(bookmarks, apiKey);
        status.innerText = "Analysis Complete!";
        setTimeout(() => {
            progress.classList.add('hidden');
            btn.disabled = false;
            // Refresh view
            renderCategories();
            alert("Analysis Complete! Check your categories.");
        }, 1000);
    } catch (error) {
        console.error(error);
        status.innerText = "Error: " + error.message;
        btn.disabled = false;
    }
});

// --- AI SERVICE ---
async function analyzeBookmarksWithGemini(bookmarksList, key) {
    const BATCH_SIZE = 10;
    const batches = [];

    for (let i = 0; i < bookmarksList.length; i += BATCH_SIZE) {
        batches.push(bookmarksList.slice(i, i + BATCH_SIZE));
    }

    let processedCount = 0;
    const status = document.getElementById('analysis-status');

    for (const batch of batches) {
        processedCount += batch.length;
        status.innerText = `Processing ${processedCount}/${bookmarksList.length}...`;

        const prompt = `
            Analyze the following bookmarks. For each, assign a single broad category (e.g., Development, Entertainment, News, Shopping, Social, Education, Finance, Travel, Other) and 3 relevant tags.
            Return ONLY a JSON object where keys are the bookmark URLs and values are objects with "category" and "tags".
            
            Bookmarks:
            ${batch.map(b => `- ${b.url} (${b.title})`).join('\n')}
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const text = data.candidates[0].content.parts[0].text;
            // Extract JSON from markdown code block if present
            const jsonStr = text.replace(/```json\n?|\n?```/g, '').trim();
            const result = JSON.parse(jsonStr);

            // Merge into aiMetadata
            aiMetadata = { ...aiMetadata, ...result };

        } catch (err) {
            console.error("Batch failed", err);
        }
    }

    // Save to Firestore
    if (currentUser) {
        li.innerHTML = `
            <div class="bm-header">
                <a href="${bm.url}" target="_blank" class="bm-link">${bm.title}</a>
                <div class="bm-actions">
                    <i class="fas fa-unlock lock-btn move-to-public" data-index="${index}" title="Move to Public"></i>
                    <i class="fas fa-trash delete-btn private-delete" data-index="${index}"></i>
                </div>
            </div>
        `;
        list.appendChild(li);
    });

    document.querySelectorAll('.private-delete').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const index = e.target.dataset.index;
            if (confirm("Delete from Vault?")) {
                const itemToDelete = privateBookmarks[index];
                privateBookmarks.splice(index, 1);

                const userRef = db.collection("users").doc(currentUser.uid);
                await userRef.update({
                    privateBookmarks: firebase.firestore.FieldValue.arrayRemove(itemToDelete)
                });

                renderPrivateBookmarks();
            }
        });
    });

    document.querySelectorAll('.move-to-public').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const index = e.target.dataset.index;
            const itemToMove = privateBookmarks[index];

            if (confirm("Move to Public? This will make it visible in Chrome bookmarks.")) {
                // Create in Chrome
                chrome.bookmarks.create({
                    title: itemToMove.title,
                    url: itemToMove.url
                }, async () => {
                    // Remove from Firestore
                    privateBookmarks.splice(index, 1);
                    const userRef = db.collection("users").doc(currentUser.uid);
                    await userRef.update({
                        privateBookmarks: firebase.firestore.FieldValue.arrayRemove(itemToMove)
                    });

                    renderPrivateBookmarks();
                    loadChromeBookmarks(); // Refresh public list
                    // Optional: Notify user
                    // alert("Moved to Public Bookmarks");
                });
            }
        });
    });
}

// FEATURE: Change PIN Logic
const updatePinBtn = document.getElementById('update-pin-btn');
if (updatePinBtn) {
    updatePinBtn.addEventListener('click', () => {
        const oldPinInput = document.getElementById('old-pin-input').value;
        const newPinInput = document.getElementById('new-pin-input').value;
        const msg = document.getElementById('pin-msg');

        chrome.storage.local.get(['bookify_pin'], (result) => {
            const savedPin = result.bookify_pin;

            if (oldPinInput !== savedPin) {
                msg.style.color = 'red';
                msg.innerText = "Old PIN is incorrect.";
                return;
            }

            if (newPinInput.length !== 4) {
                msg.style.color = 'red';
                msg.innerText = "New PIN must be 4 digits.";
                return;
            }

            chrome.storage.local.set({ bookify_pin: newPinInput }, () => {
                msg.style.color = 'green';
                msg.innerText = "PIN updated successfully!";

                document.getElementById('old-pin-input').value = '';
                document.getElementById('new-pin-input').value = '';
            });
        });
    });
}

// --- SETTINGS LOGIC ---
document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-view').classList.remove('hidden');
    views.categories.classList.add('hidden');
    views.all.classList.add('hidden');
    views.privateLocked.classList.add('hidden');
    views.privateUnlocked.classList.add('hidden');

    // Reset tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
});

document.getElementById('save-api-key-btn').addEventListener('click', () => {
    const key = document.getElementById('gemini-api-key').value.trim();
    if (key) {
        chrome.storage.local.set({ gemini_api_key: key }, () => {
            apiKey = key;
            document.getElementById('api-key-status').innerText = "API Key Saved!";
            document.getElementById('api-key-status').style.color = "green";
            document.getElementById('analyze-btn').disabled = false;
            setTimeout(() => { document.getElementById('api-key-status').innerText = ""; }, 3000);
        });
    }
});

document.getElementById('analyze-btn').addEventListener('click', async () => {
    if (!apiKey) return;

    const btn = document.getElementById('analyze-btn');
    const progress = document.getElementById('analysis-progress');
    const status = document.getElementById('analysis-status');

    btn.disabled = true;
    progress.classList.remove('hidden');
    status.innerText = "Analyzing bookmarks...";

    try {
        await analyzeBookmarksWithGemini(bookmarks, apiKey);
        status.innerText = "Analysis Complete!";
        setTimeout(() => {
            progress.classList.add('hidden');
            btn.disabled = false;
            // Refresh view
            renderCategories();
            alert("Analysis Complete! Check your categories.");
        }, 1000);
    } catch (error) {
        console.error(error);
        status.innerText = "Error: " + error.message;
        btn.disabled = false;
    }
});

// --- AI SERVICE ---
async function analyzeBookmarksWithGemini(bookmarksList, key) {
    const BATCH_SIZE = 10;
    const batches = [];

    for (let i = 0; i < bookmarksList.length; i += BATCH_SIZE) {
        batches.push(bookmarksList.slice(i, i + BATCH_SIZE));
    }

    let processedCount = 0;
    const status = document.getElementById('analysis-status');

    for (const batch of batches) {
        processedCount += batch.length;
        status.innerText = `Processing ${processedCount}/${bookmarksList.length}...`;

        const prompt = `
            Analyze the following bookmarks. For each, assign a single broad category (e.g., Development, Entertainment, News, Shopping, Social, Education, Finance, Travel, Other) and 3 relevant tags.
            Return ONLY a JSON object where keys are the bookmark URLs and values are objects with "category" and "tags".
            
            Bookmarks:
            ${batch.map(b => `- ${b.url} (${b.title})`).join('\n')}
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const text = data.candidates[0].content.parts[0].text;
            // Extract JSON from markdown code block if present
            const jsonStr = text.replace(/```json\n?|\n?```/g, '').trim();
            const result = JSON.parse(jsonStr);

            // Merge into aiMetadata
            aiMetadata = { ...aiMetadata, ...result };

        } catch (err) {
            console.error("Batch failed", err);
        }
    }

    // Save to Firestore
    if (currentUser) {
        const userRef = db.collection("users").doc(currentUser.uid);
        await userRef.update({ aiMetadata: aiMetadata });
    }
}
